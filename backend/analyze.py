from file_extraction import extract_text_from_file
import logging
import asyncio
from Enums.FileType import FileType
from FileAnalyzerRegistry import FileAnalyzerRegistry
from BaseFileAnalyzer import BaseFileAnalyzer
from typing import List, Dict, Any

logger = logging.getLogger(__name__)

async def analyze_processed_files(client,processed_files):
    results = []
    final_results = ""

    tasks = []

    for file in processed_files:
        file_name = file["filename"].lower()
        print(file_name)
        file_content = extract_text_from_file(file)
        if file_content:
            print('here')# Proceed only if text extraction was successful
            task = asyncio.create_task(analyze_content_with_gpt(client, file_name, file_content))
            if task is not None:
                tasks.append(task)

    results_list = await asyncio.gather(*tasks)
    # results_list = test_values_from_files()
    result_list = merge_results(results_list)

    return result_list

async def analyze_content_with_gpt(client, file_name: str, content: str):
    analyzer: BaseFileAnalyzer = FileAnalyzerRegistry.get_analyzer(file_name)

    if analyzer is None:
        logger.info(f"No analyzer found for file '{file_name}'. Skipping.")
        return {"filename": file_name, "info": "Type de fichier non reconnu pour l'extraction."}

    prompt = analyzer.get_prompt()
    response_model = analyzer.get_response_model()
    results = []

    try:
        # Diviser le contenu en chunks si nécessaire
        for chunk in split_text_into_chunks(content):
            completion = await client.beta.chat.completions.parse(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "Vous êtes un analyseur de documents."},
                    {"role": "user", "content": prompt + chunk}
                ],
                response_format=response_model,
            )

            if completion.choices[0].message.refusal:
                logger.warning(f"Model refused to answer for file '{file_name}'.")
                continue

            personnel_info = completion.choices[0].message.parsed
            results.append(personnel_info.dict(exclude_none=True))
        return {"filename": file_name, "info": results}

    except Exception as e:
        logger.error(f"Error extracting information with GPT for file '{file_name}': {e}")
        return {"filename": file_name, "info": "Error during GPT analysis."}


def format_liste(valeur):
    """Formate une liste en une chaîne avec des puces. Retourne une chaîne vide si la liste est vide
    ou contient des termes tels que 'non spécifié', 'non spécifiée', 'non précisé', 'non précisée'."""

    # Vérifier si la valeur est une liste
    if isinstance(valeur, list):
        valeur_filtre = []
        for v in valeur:
            if isinstance(v, str):
                v_minuscule = v.lower()
                if v_minuscule == "non spécifié" or v_minuscule == "date non spécifiée" or v_minuscule == "non spécifiée" or v_minuscule == "non précisé" or v_minuscule == "non précisée":
                    continue
            valeur_filtre.append(v)
        return "\n        • " + "\n        • ".join(map(str, valeur_filtre)) if valeur_filtre else ""

    if isinstance(valeur, str):
        valeur_minuscule = valeur.lower()
        if valeur_minuscule == "non spécifié" or valeur_minuscule == "non spécifiée" or valeur_minuscule == "non précisé" or valeur_minuscule == "non précisée":
            return ""
        return valeur

    return str(valeur) if valeur else ""


def print_file(dico):
    """Génère une chaîne représentant les données de manière conditionnelle sans afficher les valeurs vides ou 'Non spécifié'."""
    sections = [
        ("1. CONTEXTE ET ATTENTES", [
            ("Objet du marché", dico.get('titre')),
            ("Périmètre géographique", dico.get('perimetre_geographique')),
            ("Horaires d’ouverture du site", dico.get('horaires_ouverture')),
            ("Nombre de lot(s)", dico.get('nombre_agents')),
            ("Budget ou chiffre d’affaires", dico.get('prix_marche')),
            ("Calendrier et dates clés", dico.get('calendrier_dates_cles')),
            ("Missions et/ou prestations attendues", dico.get('prestations_attendues'))
        ]),
        ("2. RISQUES D’EXPLOITATION - Démarrage", [
            ("Profils requis", dico.get('profils_requis')),
            ("Livrables attendus", dico.get('livrables_attendus'))
        ]),
        ("2. RISQUES D’EXPLOITATION - Exploitation courante", [
            ("Délai et conditions de remplacement des profils", dico.get('condition_delai_remplacement')),
            ("Gestion des absences", dico.get('gestion_absences')),
            ("Formations attendues", dico.get('formations')),
            ("Matériel mis à disposition", dico.get('equipements_a_fournir')),
            ("Tenues vestimentaires requises", dico.get('tenues')),
            ("Reprise de personnel", dico.get('reprise_personnel')),
            ("Présence d’un chef d’équipe/responsable de site", dico.get('composition_equipes')),
            ("Note sociale", dico.get('note_sociale'))
        ]),
        ("3. RISQUES CDC", [
            ("Points d’attention", dico.get('points_attention')),
            ("Pénalités", dico.get('penalites'))
        ]),
        ("4. CADRE CONTRACTUEL", [
            ("Révision des prix", dico.get('revisions_prix')),
            ("Pénalités", dico.get('penalites')),
            ("Système de RFA (Remise de Fin d’Année)", dico.get('rfa_systeme')),
            ("Délai de paiement", dico.get('conditions_paiement'))
        ]),
        ("5. FORMULE DE RÉVISION DES PRIX", [
            ("Formule attendue", dico.get('formule_revision')),
            ("Explication des termes", dico.get('definitions_formule'))
        ])
    ]

    # Construire le texte en ne gardant que les sections non vides
    output = []
    for section_title, fields in sections:
        field_texts = [
            f"    **{field}** : {format_liste(value)}"
            for field, value in fields
            if format_liste(value)  # Exclure les champs vides
        ]
        if field_texts:
            output.append(f"{section_title}\n" + "\n".join(field_texts))

    return "\n\n".join(output)


def split_text_into_chunks(text, max_tokens=1500):
    words = text.split()
    for i in range(0, len(words), max_tokens):
        yield " ".join(words[i:i + max_tokens])



def test_values_from_files():
    return (
        [{'filename': 'dce offres/2_ccap/2_2024-049 ccap ssiap.docx', 'info': [{'prix_marche': [], 'prestations_attendues': ['Pilotage des prestations et gestion administrative', 'Missions de mise en exploitation', 'Formation technique par les entreprises travaux aux installations', 'Déploiement des moyens humains et matériels et des documents d’exploitation', 'Présence 24h/24 et 7j/7 d’un agent SSIAP 2 et d’un agent SSIAP 1', 'Mise en place et tenue à jour des livrables d’exploitation', 'Fourniture d’équipements tels que le matériel courant, matériel informatique et de communication, contrôleur de ronde, caméra thermique.', 'Mise à disposition d’un chef de service SSIAP 3 pour des missions de conseil technique ou de vérification', 'Renfort de l’équipe'], 'tranches_et_options': ['Sans objet'], 'prestations_supplementaires': ['Agent de sécurité incendie SSIAP 1 supplémentaire obligatoire en renfort de l’équipe « Base ».'], 'duree_marche': ['2024 à 2028'], 'equipes': ['Responsable d’équipe', 'Chef d’équipe'], 'formations': [], 'penalites': [], 'revisions_prix': [], 'conditions_paiement': [], 'qualite': [], 'formule_revision': ['P = (montant total à payer)'], 'definitions_formule': [], 'rse': [], 'clause_reexamen_modifications': []}, {'prix_marche': [], 'prestations_attendues': [], 'tranches_et_options': [], 'prestations_supplementaires': [], 'duree_marche': ['Le marché prend effet à compter de sa date de notification et s’achève douze (12) mois après la notification de l’ordre de service de démarrage des prestations de maintenance.', 'Le marché est reconductible tacitement trois (3) fois maximum pour des périodes de douze (12) mois chacune, sauf dénonciation par le pouvoir adjudicateur deux (2) mois avant la fin de la période en cours par lettre recommandée avec accusé de réception.'], 'equipes': ['Responsable du marché', "Chefs d'équipes"], 'formations': [], 'penalites': ['Le Titulaire ne peut pas refuser la reconduction du marché et ne peut se prévaloir d’aucune indemnité en cas d’absence de reconduction.', 'Toute dépense pour remise en état des équipements, des installations ou documents provenant d’un manquement du Titulaire aux obligations du présent marché, lui est imputable.'], 'revisions_prix': [], 'conditions_paiement': [], 'qualite': [], 'formule_revision': [], 'definitions_formule': [], 'rse': [], 'clause_reexamen_modifications': []}, {'prix_marche': [], 'prestations_attendues': [], 'tranches_et_options': [], 'prestations_supplementaires': [], 'duree_marche': [], 'equipes': [], 'formations': [], 'penalites': ['la constatation du non-respect des mesures de sécurité peut entraîner, après mise en demeure restée sans effet, la résiliation du présent marché aux torts du Titulaire dans les conditions définies au présent CCAP.', "d'utiliser le téléphone sans autorisation de l’EP RNDP pour un usage personnel", "d'introduire ou de consommer des boissons alcoolisées dans les locaux, aussi bien que d'y pénétrer en état d'ivresse", "de provoquer du désordre, d'une façon quelconque, sur les lieux du travail et leurs dépendances", "de tenir des réunions dans l'enceinte des locaux sans accord préalable de l’EP RNDP", 'de manquer de respect aux usagers', "de se faire aider, dans l'exécution de son travail, par une personne étrangère à l'entreprise"], 'revisions_prix': [], 'conditions_paiement': [], 'qualite': [], 'formule_revision': [], 'definitions_formule': [], 'rse': [], 'clause_reexamen_modifications': []}, {'prix_marche': ['prix globaux et forfaitaires', 'prix unitaires'], 'prestations_attendues': [], 'tranches_et_options': [], 'prestations_supplementaires': [], 'duree_marche': [], 'equipes': ['responsable d’équipe', 'chef d’équipe'], 'formations': [], 'penalites': ['1 jour ouvré', 'sous peine de forclusion'], 'revisions_prix': ['les prix sont révisables'], 'conditions_paiement': ['unique facturation au terme de la période', 'facturation trimestrielle terme à échoir', 'présentation d’une facture mensuelle'], 'qualite': [], 'formule_revision': ['P = Po x [0,2 + 0,8 Im-4 / I0-4]'], 'definitions_formule': ['P est le prix révisé', 'Po est le prix initial', 'I0-4 est la valeur de l’indice I pour le mois antérieur de 4 mois au mois zéro', 'Im-4 est la valeur de ce même indice pour le mois antérieur de 4 mois à la date de notification de l’ordre de service'], 'rse': [], 'clause_reexamen_modifications': ['le présent marché pourra être modifié dans l’hypothèse décrite au présent article']}, {'prix_marche': [], 'prestations_attendues': [], 'tranches_et_options': [], 'prestations_supplementaires': [], 'duree_marche': [], 'equipes': [], 'formations': [], 'penalites': ['Pénalité de 50€ par jour calendaire de retard pour non-production des déclarations de sous-traitance. Pénalité de 50€ par jour calendaire de retard pour non-production des attestations d’assurance.'], 'revisions_prix': [], 'conditions_paiement': [], 'qualite': [], 'formule_revision': ["P = taux de l'avance"], 'definitions_formule': [], 'rse': [], 'clause_reexamen_modifications': []}, {'prix_marche': [], 'prestations_attendues': [], 'tranches_et_options': [], 'prestations_supplementaires': [], 'duree_marche': [], 'equipes': [], 'formations': [], 'penalites': ['Pénalités financières en cas de résultat insatisfaisant', 'Pénalités appliquées si les notations de trois mois consécutifs sont inférieures à 90%', 'Les pénalités seront appliquées directement sur les sommes dues à l’entreprise sans que l’EP RNDP ne soit obligée de faire parvenir un courrier recommandé au Titulaire pour stipuler le montant des pénalités à déduire de la facturation', 'Si les résultats révèlent un non-respect des spécifications du contrat, le Titulaire devra y remédier sous un délai d’une semaine sous peine de pénalités.'], 'revisions_prix': [], 'conditions_paiement': [], 'qualite': [], 'formule_revision': ['P = (Résultat insatisfaisant : 0% à 75 %, Résultat moyen : 75% à 90%, Résultat satisfaisant : 90% à 100%)'], 'definitions_formule': [], 'rse': [], 'clause_reexamen_modifications': ['Si de nouveaux équipements sont pris en charge et si des équipements existants sont abandonnés au cours de l’exécution du marché, un avenant sera conclu afin d’indiquer le nouveau prix global forfaitaire sur la base des prix initiaux du marché.', 'Il peut être fait application des clauses de réexamen stipulées ci-après.']}, {'prix_marche': [], 'prestations_attendues': [], 'tranches_et_options': [], 'prestations_supplementaires': [], 'duree_marche': [], 'equipes': [], 'formations': [], 'penalites': ['Si le Titulaire n’accomplit pas les diligences nécessaires à l’exercice de sa mission', 'Si Titulaire déclare ne plus pouvoir exécuter ses engagements', 'Lorsque le Titulaire s’est livré, à l’occasion des prestations, à des actes frauduleux, portant sur la nature, la qualité ou la quantité desdites prestations', 'En cas de retard significatif, retards successifs et/ou absences répétées aux réunions', 'Si le Titulaire n’honore pas un bon de commande', 'Si le Titulaire ne fournit pas son attestation d’assurance', 'En cas de non-respect des obligations et/ou prestations telles que définies dans les documents contractuels'], 'revisions_prix': [], 'conditions_paiement': [], 'qualite': [], 'formule_revision': ['P = '], 'definitions_formule': [], 'rse': [], 'clause_reexamen_modifications': []}]}, {'filename': 'dce offres/2_ccap/2_2024-049 ccap ssiap annexe1-indicateur et penalites.xlsx', 'info': [{'prix_marche': [], 'prestations_attendues': [], 'tranches_et_options': [], 'prestations_supplementaires': [], 'duree_marche': [], 'equipes': [], 'formations': [], 'penalites': ["Absence du (des) représentant(s) du TITULAIRE à une réunion programmée ou à une convocation de l'EP RNDP : 100 (Cent) €uros HT par personne absente", "Non-respect de la collaboration avec les autres prestataires de l'EP RNDP : 100 (Cent) €uros HT par défaillance constatée", 'Non-respect de la tenue contractuelle ou tenue négligée : 100 (Cent) €uros HT par défaillance constatée', "Utilisation de locaux sans accord de l'EP RNDP : 100 (Cent) €uros HT par défaillance constatée", 'Non-respect des délais de création et remise des documents prévus au contrat : 50 (Cinquante) €uros HT par document et par jour calendaire de retard au-delà du délai fixé', 'Non tenue à jour, ou non-présentation des documents prévus au Marché : 100 (Cent) €uros HT par document et par constat', 'Non tenue à jour de la main courante : 100 (Cent) €uros HT par constat', 'Non fonctionnement des matériels utiles à la prestation : 100 (Cent) €uros HT par constat', 'Non fonctionnement ou non tenue à disposition au PCSI des moyens de communication : 100 (Cent) €uros HT par constat', 'Non respect des fournitures demandées dans le marché : 100 (Cent) €uros HT par constat', "Non respect des fournitures présentes sur site à la charge de l'EP RNDP : 100 (Cent) €uros HT par constat", 'Non réalisation des rondes définies dans le Marché : 100 (Cent) €uros HT par constat', 'Abus des moyens téléphoniques pour des raisons autres que celles du service : Remboursement des communications identifiées comme abusives', 'Non-respect des consignes ou des dispositions d’un document : 200 (Deux Cent) €HT par constat', 'Observations notifiées sur le PV de la commission de sécurité imputables au TITULAIRE : 750 (Sept-cent cinquante) €HT par observation sur le PV de la commission de sécurité', 'Plaintes et réclamations clients : 200 (Deux Cent) €HT x Nombre de plaintes justifiées', "Aucune évacuation de la Cathédrale, suite à une alarme incendie intempestive et à une procédure non maîtrisée par le TITULAIRE : 750 (Sept-cent cinquante) €HT suite à procédures non maîtrisées, pouvant s'additionner à la pénalité liée à la continuité de l'activité", 'Non-restitution de documents en fin de contrat : 1/20ème du prix global et forfaitaire sur la durée entière du contrat', "Fourniture des données nécessaires à l'élaboration du plan de prévention : 50 (Cinquante) €uros HT par document et par jour calendaire de retard au-delà du délai fixé", "Mise en place initiale des documents d'exploitation : 100 (Cent) €uros HT par matériel et par jour calendaire de retard au-delà du délai fixé", "Respect des permanences contractuelles : 200 (Deux Cent) €HT x Nombre d'heures sur la période écoulée (toute heure commencée est comptée entière)", "Respect des délais d'intervention définis au marché : 50 (Cinquante) €uros par tranche de 5 minutes (toute tranche commencée est comptée entière)", "Perturbation activités hébergées suite à une défaillance imputable au prestataire : 1000 (Mille) €HT x Nombre de jours de perturbation de l'activité hébergée", "Non respect d'une clause du marché liée à une prestation de sécurité incendie : 200 (Deux Cent) €HT par constat", "Non respect d'une clause du marché liée à une prestation d'assistance sanitaire : 200 (Deux Cent) €HT par constat", "Non respect d'une clause du marché liée à une prestation de conseil : 200 (Deux Cent) €HT par constat", "Non respect d'une clause du marché liée à une prestation autre : 200 (Deux Cent) €HT par constat", "Contrôle mensuel des équipements liés à la sécurité : 150 (Cent cinquante) €HT si le contrôle mensuel n'a pas été fait", 'Respect du planning de réalisation des autocontrôles : 50 (Cinquante) €uros HT par constat', 'Vérification que le cahier des consignes est à jour : 200 (Deux Cent) €HT x Nbre de consignes non présentes ou non actualisées dans le cahier de consignes', 'Respect des qualifications et des formations du personnel : 100 (Cent) €HT par constat', 'Respect des périodes de recouvrement minimales imposées au cahier des charges : 100 (Cent) €HT x Nbre de jours de recouvrement non respectés', "Aucune consigne ou procédure non maîtrisée lors d'un contrôle : 100 (Cent) €HT x Nbre de consignes ou procédures non maîtrisées", "Non-respect d’une exigence ou d'un objectif contractuel : 100 (Cent) €uros HT par constat"], 'revisions_prix': [], 'conditions_paiement': [], 'qualite': [], 'formule_revision': [], 'definitions_formule': [], 'rse': [], 'clause_reexamen_modifications': []}]}, {'filename': 'dce offres/2_ccap/2_2024-049 ccap_annexe2-ediflex.pdf', 'info': [{'prix_marche': ['non spécifié'], 'prestations_attendues': ['Gestion dématérialisée de la facturation des marchés de prestations de fournitures et services', 'Consultation des conditions financières des marchés', 'Enregistrement des DPGF et bordereaux de prix', 'Vérification des situations des entreprises', 'Validation des situations pour mise en intention de paiement'], 'tranches_et_options': ['non spécifié'], 'prestations_supplementaires': ['Avenants éventuels'], 'duree_marche': ['non spécifié'], 'equipes': ["Responsable du marché : Maître d'Ouvrage", "Chef d'équipe : Maître d’œuvre"], 'formations': ['Formation initiale des utilisateurs au service EDIFLEX', 'Formation ultérieure à la charge du titulaire du marché'], 'penalites': ['Non respect des conditions financières', 'Retards de saisie des données', 'Problèmes de vérification des situations des entreprises'], 'revisions_prix': ['DPGF (Décompositions du Prix Global et Forfaitaire)', 'Calcul des révisions'], 'conditions_paiement': ["Le Maître d'Ouvrage émet son avis d'intention de payer et transmet les pièces justificatives dans un délai permettant un paiement à J+30"], 'qualite': ['Qualité de service de la société EPICTURE'], 'formule_revision': ['P = DPGF - (Réduction éventuelle)'], 'definitions_formule': ['DPGF : Décomposition du Prix Global et Forfaitaire'], 'rse': ['Non spécifié'], 'clause_reexamen_modifications': ['Non spécifié']}, {'prix_marche': [], 'prestations_attendues': [], 'tranches_et_options': [], 'prestations_supplementaires': [], 'duree_marche': [], 'equipes': [], 'formations': ['formation initiale pour deux utilisateurs'], 'penalites': ['Obligation de discrétion', "Les paiements effectués aux sous-traitants par l'agent comptable sur la base de ces documents ne sauraient donner lieu à contestation ultérieure dans la relation susceptible d’intervenir entre l’entreprise et ses sous-traitants."], 'revisions_prix': [], 'conditions_paiement': [], 'qualite': [], 'formule_revision': [], 'definitions_formule': [], 'rse': [], 'clause_reexamen_modifications': []}]}, {'filename': 'dce offres/1_ae/1_2024-049 ae ssiap annexe 1-bpu.xlsx', 'info': [{'nombre_agents': [10], 'nombre_cdi': [0], 'nombre_cdd': [0], 'autres_details': ["Les taux horaires comprennent le salaire brut de l'agent et toutes sujétions nécessaires (fourniture d'un vêtement de travail et d'un insigne de la société, prise en charge des frais de transport, formation continue, etc.). Aucun frais supplémentaire ne s'appliquera pour la mise à disposition d'un agent sur bon de commande."]}]}, {'filename': 'dce offres/1_ae/1_2024-049 ae ssiap annexe 2-dpgf-cdt.xlsx', 'info': "Type de fichier non reconnu pour l'extraction."}, {'filename': 'dce offres/1_ae/1_2024-049 ae ssiap.docx', 'info': "Type de fichier non reconnu pour l'extraction."}, {'filename': 'dce offres/3_cctp/2_2024-049 cctp ssiap annexe 1-engagements de services.xlsx', 'info': [{'perimetre_geographique': [], 'horaires_ouverture': ['24h/24'], 'missions': ['Prestations de sécurité incendie', "Prestations d'assistance aux personnes"], 'prestations_attendues': [], 'penalites': ['Absence au poste de sécurité : 0', "Retard inférieur à 15 minutes dans la prise de service (cumul pour l'ensemble des agents) : 2", "Retard supérieur à 15 minutes dans la prise de service (cumul pour l'ensemble des agents) : 1", 'Absence supérieure à 2 heures : 0', 'Retours négatifs écrits de collaborateurs par rapport à la prestation de sécurité : 0', "Retard dans la réalisation d'un contrôle planifié : 2 jours ouvrés", 'Rondes non réalisées ou incomplètes : 2', "Appel téléphonique manqué au poste de sécurité (abandon) après un temps de sonnerie supérieur à 30 secondes (téléphone d'urgence) : 0", 'Non respect 2024-10-26T13:39:21.760984384Z des consignes et des procédures d’escalade : 0'], 'composition_equipes': [], 'equipements_a_fournir': ['équipements du personnel, vêtements de travail adaptés aux postes de travail', 'équipements de protection individuelle (gants, harnais, bottes…)', 'caisses à outils nécessaires aux interventions et petits dépannages d’urgence', 'contrôleur de rondes et pointaux associés sur l’ensemble du Site', 'caméra thermique', '1 talkie-walkie pour chaque agent et 1 pour le CMN', '1 base de talkie-walkie', "1 téléphone portable pour le chef d'équipe", 'équipements informatiques (ordinateurs, imprimante…)', 'main courante informatique accessible au PCSI, yc poste informatique', 'fournitures de bureaux (registres, carnet de bordereau, cahiers, classeurs…)', 'postes téléphoniques et communications téléphoniques de service', 'mobilier du poste de sécurité', 'mobilier de la base vie : vestiaires, réfrigérateur…', 'fluides et énergies : eau de ville, électricité…', 'trousses à pharmacie de première urgence et leur réapprovisionnement', 'matériel pour faciliter l’évacuation lors de l’assistance aux personnes (fauteuil roulant…)', 'produits nécessaires aux essais de fonctionnement courant (aérosols d’essais de détecteurs incendie,…),', 'défibrillateur', 'tensiomètre', 'matériels et fournitures de balisage pour la signalisation des zones interdites (plots, rubalise…)'], 'pse': [], 'details_processus_operationnels': ["Délais maximums Interventions : Prise en compte d'une alarme au poste de sécurité < 45 secondes", 'Réponse au téléphone "normal" du poste de sécurité < 30 secondes', 'Levée de doute in-situ (suite à détection incendie) < 5 minutes', 'Intervention sanitaire et d’assistance aux personnes < 5 minutes', "Traitement d'une alarme technique : levée de doute + appel de l'astreinte < 10 minutes", "Remplacement : Remplacement d'un agent < 4 heures", 'Documents liés a la phase 1 "Mise en exploitation" - Délais de remise : Etablissement du plan de prévention 1 mois avant le début de la phase 2', "Documents à remettre à l'EP RNDP - Délais de remise : Présentation à l'EP RNDP de l'état des formations Tous les mois lors des réunions mensuelles"]}]}, {'filename': 'dce offres/3_cctp/2_2024-049 cctp ssiap annexe 2-indicateurs de performance.xlsx', 'info': [{'perimetre_geographique': [], 'horaires_ouverture': [], 'missions': [], 'prestations_attendues': [], 'penalites': ['Astreinte Conventionnelle de base définie au contrat pour non respect des exigences et objectifs de résultats : P0* = 100 €HT', 'P0*/5 x (90 - note Qualité) si la note Qualité est inférieure à 90%', 'P0* x 2 x Nombre de plaintes justifiées si des plaintes justifiées sont constatées', "P0* x 2 x Nombre de 1/2 heure sur la période échue en cas d'absence ou retard", 'P0*/2 x Nombre de jours calendaires de retard au-delà du délai fixé pour le planning prévisionnel', 'P0*/2 x Nombre de jours calendaires de retard au-delà du délai fixé pour le rapport mensuel', 'P0* x Nbre cumulé de jours ouvrés de retard au-delà des 2 premiers jours ouvrés tolérés pour le respect du planning des contrôles et vérifications', "P0* x 2 si le contrôle mensuel n'a pas été fait", 'Aucun retard toléré pour le respect des délais de remise du reporting (3)', "Aucun écart toléré pour le respect des fréquences d'autocontrôles (4)", "Aucun manquement dans le contrôle de l'élaboration et de la remise du planning d'organisation et de présence mensuel (4)", 'Aucun manquement dans le reporting (4)', 'Aucun incident sans 1 compte-rendu (3)', 'Aucun retard toléré pour la présence quotidienne des moyens minimaux spécifiés (5)', "Sous un délai de 2 semaines suivant l'arrivée d'un nouveau salarié pour la vérification de l'information des nouveaux arrivants (2)", 'Aucun écart pour la vérification de la validité des qualifications, formations et habilitations (4)', 'Aucun écart pour la vérification du port et de la propreté des uniformes (4)', "Aucun manquement pour l'exécution des rondes de sécurité selon les fréquences définies (5)", "Aucun écart toléré pour les interventions effectuées en cas de sinistre, d'incident ou d'accident (4)", "Nombre d'équipements défectueux < 1 % pour les essais périodiques sur les équipements de sécurité (5)", '100% des alarmes prises en compte dans la vérification de la gestion des alarmes (5)', 'Respect total des procédures pour les permis feu ou poussières (5)', 'Respect total des procédures dans le contrôle réglementaire (5)', "Respect total des procédures pour l'assistance à l'évacuation des PMR (5)", 'Aucun écart toléré dans le contrôle de la connaissance du site par les agents (5)', 'Aucun écart toléré dans la connaissance des équipements de sécurité par les agents (5)', "Aucun écart toléré dans l'exhaustivité des documents présents dans l'outil (4)", "Aucun écart toléré pour la présence à demeure du matériel nécessaire à l'exécution des tâches de sécurité (5)", "Aucun écart toléré pour la présence à demeure des fournitures nécessaires à l'exécution des tâches de sécurité (5)", 'Aucun écart toléré pour la présence à demeure des talkies-walkies (5)'], 'composition_equipes': [], 'equipements_a_fournir': [], 'pse': [], 'details_processus_operationnels': ['Vérification de la présence quotidienne des moyens minimaux spécifiés dans le cahier des charges selon les horaires de fonctionnement', "Vérification, par constat des interventions effectuées en cas de sinistre, d'incident ou d'accident, du respect du délai d'intervention", "Vérification de l'exécution des essais périodiques et réglementaires sur les équipements de sécurité", 'Vérification par constat de la prise en compte des alarmes incendie et des alarmes techniques', "Vérification de la connaissance des procédures d'utilisation des équipements par les agents"]}]}, {'filename': 'dce offres/3_cctp/2_2024-049 cctp ssiap.docx', 'info': [{'perimetre_geographique': ['Intérieur de la limite périphérique', 'Limite périphérique elle-même', 'Clôture Viollet-Le-Duc', 'Cathédrale et ses abords', 'Sacristie', 'Presbytère', 'Jardin attenant', 'Zones de travaux postérieure à la réouverture (éventuellement exclues)'], 'horaires_ouverture': ['Tous les jours de la semaine', '07h45 à 18h45 en semaine', '07h45 à 19h45 les samedis et dimanches', "Fermeture décalée à 23h les soirs d'événements"], 'missions': ['Réalisation de prestations de sécurité incendie', 'Conseil et assistance aux personnes', 'Garantir la sécurité des biens et des personnes', 'Assistance sanitaire aux personnes', 'Continuité des activités de la Cathédrale Notre-Dame de Paris', 'Pertinence des conseils', 'Modalités d’intervention et réactivité', 'Respect des missions attendues', 'Qualité des méthodes et organisation', 'Qualité globale des services'], 'prestations_attendues': ['Prise en charge des prestations avec obligation de résultats', 'Mise en œuvre de moyens minimaux', 'Compléter les prestations pour respecter la réglementation', 'Garantir l’absence d’incidents', 'Respect des obligations contractuelles et réglementaires'], 'penalites': ['Non conformité aux obligations contractuelles', 'Retard dans l’exécution des prestations', 'Absence de moyens techniques et logistiques nécessaires'], 'composition_equipes': ["TITULAIRE responsable de l'exécution des prestations", 'Collaborateurs internes des parties prenantes', 'Agents du CMN', "Salariés de l'EP RNDP", 'Prestataires pour maintenance des équipements'], 'equipements_a_fournir': ['Moyens techniques', 'Moyens logistiques', 'Moyens matériels et logiciels'], 'pse': ['Engagement à collaborer avec les acteurs en charge de la sécurité incendie', 'Création de synergies opérationnelles entre intervenants'], 'details_processus_operationnels': ["Observation des niveaux d'accueil durant les offices religieux", 'Participation à des évènements particuliers', "Gestion de la continuité de service et rapidité d'intervention", "Le TITULAIRE doit demander des renseignements sur les activités cultuelles à l'avance"]}, {'perimetre_geographique': ['Cathédrale Notre Dame de Paris'], 'horaires_ouverture': ['24h/24', '7j/7'], 'missions': ['Assister aux formations dispensées par les entreprises de travaux sur les différents systèmes concourant à la sécurité incendie du Site', 'Participer à la visite initiale de la Commission de sécurité', 'Déployer les moyens et documents d’exploitation', 'Organiser les moyens humains et matériels', 'Initier les outils utiles à l’exploitation', 'Définir et mettre en place les prestations opérationnelles et la documentation demandée (procédures, rapports, etc.)'], 'prestations_attendues': ['Pilotage des prestations et gestion administrative', 'Préstation de sécurité incendie, sanitaire, secours et assistance aux personnes', 'Mise en place et tenue à jour des livrables d’exploitation', 'Fourniture d’équipements tels que le matériel courant (tenues vestimentaires, EPI, …), matériel informatique et de communication, contrôleur de ronde, caméra thermique.'], 'penalites': ['Pénalités pour non-respect des délais prévus', 'Pénalités financières liées aux prestations non conformes aux exigences', 'Pénalités en cas de défaut d’information sur l’avancement des travaux'], 'composition_equipes': ['Agent SSIAP 2', 'Agent SSIAP 1', 'Chef de service SSIAP 3 pour des missions de conseil technique'], 'equipements_a_fournir': ['Matériel courant (tenues vestimentaires, EPI, ...)', 'Matériel informatique et de communication', 'Contrôleur de ronde', 'Caméra thermique'], 'pse': [], 'details_processus_operationnels': ['Processus de déploiement des moyens humains et matériels', 'Reporting des activités liées à la sécurité', 'Suivi et surveillance des systèmes électroniques de sécurité', 'Mise à jour de la documentation d’exploitation']}, {'perimetre_geographique': ['Site de la Cathédrale Notre-Dame de Paris'], 'horaires_ouverture': [], 'missions': ['Obtenir l’entière continuité de service dès la prise d’effet opérationnelle des prestations', 'Participer aux formations techniques liées aux installations', 'Assurer la formation du personnel sur le site', 'Participer à la visite initiale de la commission de sécurité', 'Déployer et mettre en place les moyens humains et matériels pour la phase de mise en exploitation'], 'prestations_attendues': ['Déploiement des équipes et moyens spécifiques', 'Fourniture de documents d’exploitation', 'Gestion du stock pharmacie et sacs de premiers secours', 'Formation du personnel', 'Organisation des séances de formation pour les guide-files et serre-files'], 'penalites': ['Délai de remise des livrables non respecté', 'Absence de participation aux réunions préparatoires', 'Non-observation des délais de mise en place des procédures d’exploitation'], 'composition_equipes': ['SSIAP2', 'SSIAP1', 'Remplaçants'], 'equipements_a_fournir': ['Matériel de sécurité incendie', 'Logiciel de gestion de la main courante électronique'], 'pse': [], 'details_processus_operationnels': ['Mise à jour du registre de sécurité', "Préparation et conformité aux règles de l'art en matière de sécurité incendie", 'Déploiement de rondes de sécurité régulières', 'Contrôle des systèmes de sécurité incendie', 'Mise en place des procédures d’exploitation en conformité avec le SGOS et le RIS']}, {'perimetre_geographique': ['Cathédrale Notre-Dame de Paris'], 'horaires_ouverture': [], 'missions': ["Prendre toutes les dispositions utiles pour empêcher que se trouvent réunies les conditions d'accidents, d’incendie, ou autres incidents", 'Faire appliquer et appliquer, lui-même, avec la plus extrême rigueur, les instructions relevant des textes et les consignes particulières au Site qui lui sont communiquées par le POUVOIR ADJUDICATEUR', "S'informer en permanence des risques généraux et particuliers du Site", 'Assurer la protection des biens et œuvres', 'Prêter assistance aux personnes (premiers secours, etc.)', "Signaler les anomalies et y remédier dans la mesure de ses moyens, notamment lors d’encombrement des voies d'accès aux moyens de secours", "Intervenir sans délai lors d'incidents ou accidents, pour en supprimer ou tout au moins en limiter les effets", 'Effectuer tous les contrôles et rondes de sécurité incendie', 'Suivre et interpréter les informations fournies par la GTB', 'Participer aux visites de la commission de sécurité', 'Alerter les services de la BSPP ou secours extérieurs au Site', 'Exploiter le système de sécurité incendie du Site', 'Recueillir les appels', 'Appeler les secours extérieurs', 'Superviser et coordonner les moyens humains participant aux levées de doute, à l’évacuation du public et des effectifs présents sur le Site et à toute action de sécurité incendie et d’assistance à personnes', 'S’assurer de la bonne évacuation du public et des effectifs présents sur le Site', 'Prendre les mesures nécessaires face à un début d’incendie et tenter de le contenir', 'Se mettre à disposition du chef de détachement d’intervention des sapeurs-pompiers'], 'prestations_attendues': ['Constitution de l’équipe de sécurité incendie (moyens humains minimaux)'], 'penalites': ['En cas d’intervention d’urgence liée à une levée de doute (départ de feu)', 'Le remplacement doit être effectif sous un délai maximum de 4 heures.'], 'composition_equipes': ['Le personnel devra répondre aux qualifications prévues par l’arrêté du 2 mai 2005 relatif aux missions, à l’emploi et à la qualification du personnel permanent des services de sécurité incendie des ERP et des IGH ainsi que l’arrêté du 5 novembre 2010 concernant les habilitations électriques', "L’équipe proposée doit également permettre de répondre aux exigences de l’Article EL18 (Règlement de sécurité contre l'incendie relatif aux établissements recevant du public) imposant la présence physique d'une personne qualifiée, requise pendant la présence du public."], 'equipements_a_fournir': ['Système de sécurité incendie', 'Équipements de sécurité incendie (clapets coupe-feu, portes sur ventouse, etc.)'], 'pse': ['Renfort à l’équipe « Base »', 'Personnel SSIAP 1 supplémentaire selon la Prestation Supplémentaire Eventuelle (PSE)'], 'details_processus_operationnels': ["Les contrôles et toutes les interventions sont consignés dans le registre dit 'main courante'", 'Avant leur prise de fonction, les employés du TITULAIRE doivent faire l’objet d’une information préalable aux contraintes d’exploitation du Site', 'Le dossier est entreposé en permanence au PCSI du Site et est mis à jour dès changement dans l’équipe du TITULAIRE', 'Le planning de présence mensuel est remis au POUVOIR ADJUDICATEUR avant le 15 du mois M pour le mois M+1', 'Le TITULAIRE s’assure 24h/24 et 7J/7 de la présence sur Site de son équipe', 'Le TITULAIRE indique les dispositions prises pour y remédier au plus vite et informe de l’arrivée de l’agent assurant le remplacement du poste concerné']}, {'perimetre_geographique': ['site de la Cathédrale'], 'horaires_ouverture': [], 'missions': ['Assurer une permanence au Poste Central Incendie', 'Effectuer les missions définies par le Règlement de Sécurité des ERP', 'Assurer la vérification des pressions des réseaux incendie', 'Contrôle des extincteurs', 'Vérification de la position des clapets coupe-feu', 'Vérifier le bon fonctionnement des installations de détection incendie', 'Contrôler le bon fonctionnement des équipements de sécurité', 'Vérifier le bon fonctionnement des installations d’interphonie', 'Assurer le bon fonctionnement des systèmes d’alarme et d’alerte', 'Surveiller le bon fonctionnement du système de caméras de détection', 'S’informer sur les risques généraux et particuliers du site', 'Assister les organismes de vérification lors des visites et contrôles  ', 'Exploiter les informations issues des prestations de sûreté'], 'prestations_attendues': ["Tenue d'un registre de sécurité", 'Mise en place de rondes de sécurité', 'Dresser la liste des es2024-10-26T13:39:21.760984384Z sais et contrôles de fonctionnement', 'Accompagnement lors des visites de sécurité et de contrôle', 'Suivi de la maintenance des équipements de sécurité'], 'penalites': ['le non-respect des effectifs minimaux entrainera automatiquement la mise en œuvre des pénalités définis dans le Marché.'], 'composition_equipes': ['Chef d’équipe SSIAP 2', 'Agents de sécurité'], 'equipements_a_fournir': [], 'pse': [], 'details_processus_operationnels': ['Le planning de congés et de remplacements prévus doit être soumis à validation préalable du POUVOIR ADJUDICATEUR.', 'La réalisation des rondes devra être consignée dans la main-courante électronique.', 'Une procédure de vérification doit être établie pour chaque équipement et validée par le POUVOIR ADJUDICATEUR avant sa mise en application.', 'Réaliser à minima toutes les 2 heures, une ronde générale ou technique.']}, {'perimetre_geographique': ['Site', 'Cathédrale Notre Dame de Paris'], 'horaires_ouverture': [], 'missions': ['Centraliser et archiver les rapports d’intervention', "Assister les entreprises dans l'organisation des périmètres de sécurité", 'Gestion des permis de feu et poussière', 'Formation du personnel à la sécurité incendie', 'Organiser les exercices d’évacuation'], 'prestations_attendues': ["Rapports mensuels d'activité", 'Gestion des formations du personnel', "Assistance à l'évacuation des personnes à mobilité réduite", 'Gestion et suivi des incidents et des interventions', 'Supervision des systèmes de secours'], 'penalites': ['Suspension des travaux jusqu’à validation d’un ordre d’intervention', 'Travaux stoppés si un permis de feu n’a pas été établi', 'Non-validation de programmes de formation'], 'composition_equipes': [], 'equipements_a_fournir': [], 'pse': [], 'details_processus_operationnels': ['Observations des plans de prévention des risques', 'Gestion des permis feu avec une seule société', 'Contrôle et mise à jour du cahier des procédures', 'Visite préalable et transcription des constats sur le permis de feu', 'Rondes de sécurité et vérification des points chauds', 'Déclaration des anomalies dans la main courante électronique', 'Dépot des documents sur outil numérique de partage', 'Supervision de la remise en fonction des moyens de secours après incidents', 'Établissement de rapports d’interventions sanitaires dans les 12 heures']}, {'perimetre_geographique': ['Site de la Cathédrale Notre Dame de Paris'], 'horaires_ouverture': [], 'missions': ['Rondements de sécurité', 'Réarmement des clapets coupe-feu', 'Interventions sur les alarmes techniques', 'Signalement des anomalies', 'Conseil sur les dispositions humaines et techniques pour les évènements particuliers'], 'prestations_attendues': ['Fourniture et entretien des équipements de sécurité', "Fourniture et entretien du matériel nécessaire à l'exécution des prestations", 'Réalisation de rondes de contrôle', 'Contrôle régulier du fonctionnement des équipements', 'Gestion des stocks de consommables'], 'penalites': ["Le POUVOIR ADJUDICATEUR se réserve le droit de demander le remboursement des communications téléphoniques au TITULAIRE en cas d'abus", 'Le TITULAIRE ne pourra se prévaloir, ni pour éluder les obligations du Marché, ni pour élever une réclamation, d’une pièce manquante dans le stock, pour justifier d’un dépassement des délais contractuels.'], 'composition_equipes': ['Agents de l’équipe de sécurité', "Personnel affecté à l'exécution de la prestation"], 'equipements_a_fournir': ['Tenues vestimentaires identiques et adaptées', 'Équipements de protection individuelle (gants, bottes...)', 'Caisse à outils', 'Fournitures de bureau', 'Matériel informatique (ordinateur, imprimante)', '3 talkies-walkies, 1 base de talkie-walkie, 1 téléphone portable pour le Chef d’Équipe', 'Caméra thermique'], 'pse': [], 'details_processus_operationnels': ['Contrôle régulier du bon fonctionnement des défibrillateurs', 'Supervision de la maintenance des défibrillateurs', 'Gestion des stocks de consommables', 'Prévention du POUVOIR ADJUDICATEUR pour renouveler les stocks.']}, {'perimetre_geographique': ['Cathédrale Notre-Dame de Paris'], 'horaires_ouverture': [], 'missions': ['Veiller à la sécurité incendie sur le site', 'Actualiser le registre de sécurité', "Élaborer et mettre à jour le planning d'intervention", 'Rédiger le cahier des procédures', 'Transmettre la main courante au pouvoir adjudicateur', "Fournir des comptes-rendus d'intervention", 'Remettre des rapports mensuels et annuels de sécurité', 'Participer aux réunions mensuelles et hebdomadaires'], 'prestations_attendues': ['Mise à jour du registre de sécurité', "Planning d'intervention", 'Cahier des procédures', 'Main courante', "Compte-rendu d'intervention", 'Rapport mensuel et annuel de sécurité'], 'penalites': ["Inférieur à 45 secondes pour la prise en compte d'une alarme au poste de sécurité", "Inférieur à 30 secondes pour la réponse au téléphone 'normal'", 'Inférieur à 5 minutes pour les interventions sur détection incendie', 'Inférieur à 5 minutes pour les interventions sanitaires et d’assistance aux personnes', 'Inférieur à 10 minutes pour les interventions sur alarme technique', "Inférieur à 4 heures pour le remplacement d’un agent en cas de défaillance de l'effectif prévu", 'Inférieur à 24 heures pour les comptes rendus d’intervention', 'Avant le 10 de chaque mois pour la remise du rapport mensuel précédent', 'Avant le 15 janvier de chaque année pour la remise du rapport annuel'], 'composition_equipes': [], 'equipements_a_fournir': [], 'pse': [], 'details_processus_operationnels': ['Consignation des demandes d’intervention sur la main courante', 'Préparation des comptes rendus d’intervention', 'Remise des rapports mensuels et annuels', 'Réunions mensuelles pour les mises à jour et le suivi des missions']}, {'perimetre_geographique': [], 'horaires_ouverture': [], 'missions': [], 'prestations_attendues': [], 'penalites': ['Les manquements dans la documentation technique transmise par le POUVOIR ADJUDICATEUR sont énumérés dans le procès-verbal de prise en charge.', 'Assumer, en cas de dégradation, les frais de réparation ou de remplacement du matériel hors usage.', 'Toute dépense pour la remise en état des équipements, des installations ou documents provenant d’un manquement du TITULAIRE aux obligations du présent Marché, lui est retenue ou facturée.'], 'composition_equipes': [], 'equipements_a_fournir': ['Moyens de communication', 'Badges', 'Clefs'], 'pse': [], 'details_processus_operationnels': ['Laisser les équipements, les locaux, les matériels en état normal d’entretien et de fonctionnement, de réparation.', 'Initier, le cas échéant, le personnel du nouveau TITULAIRE chargé des prestations, à la notification du Marché et dans un délai maximum d’un mois.', 'Cette initiative doit en particulier comprendre la communication de tous les plans, documents et instructions reçues.', 'L’autorisation au personnel du nouveau TITULAIRE d’accéder aux installations et locaux avant expiration du contrat.', 'Établir un procès-verbal contradictoirement avec le POUVOIR ADJUDICATEUR, de l’état des lieux et des équipements.', 'Établir un arrêté des comptes et un état des ordres de services et engagements de dépenses, restant à facturer au POUVOIR ADJUDICATEUR.', 'Le TITULAIRE s’engage à lever les réserves, identifiées dans le procès-verbal, relatives à l’inexécution d’une quelconque de ses obligations.']}]}]
    )



def merge_results(results_list: List[Dict[str, Any]]) -> Dict[str, Any]:
    result = {}
    for item in results_list:
        info_entries = item.get('info', [])
        if isinstance(info_entries, str):
            continue  # Passer cette itération si 'info' est une chaîne

        for info_dict in info_entries:
            for key, value in info_dict.items():
                if key not in result:
                    result[key] = set()  # Utilisation d'un set pour stocker des valeurs uniques

                if isinstance(value, str) and 'non spécifié' in value.lower():
                    continue

                if value:
                    result[key].update(value if isinstance(value, list) else [value])

    # Convertir les sets en listes pour le retour
    return {k: list(v) for k, v in result.items()}


# """
#         Date limite de remise des offres : {format_liste(dico.get('date_limite_remise_offres'))}
#         Date de remise des offres : {format_liste(dico.get('date_remise_offres'))}
#         Date de démarrage du marché : {format_liste(dico.get('date_demarrage'))}
#         Durée du marché : {format_liste(dico.get('duree_marche'))}
#         Date de visite de site : {format_liste(dico.get('date_visite'))}
#   Autres dates importantes : {format_liste(dico.get('autres_dates_importantes'))}
#         Critères d’attribution : {format_liste(dico.get('criteres_attribution'))}
# """